<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Student Dashboard - APNA Card</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- App Icons & Manifest -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="application-name" content="APNA Card">
    <meta name="apple-mobile-web-app-title" content="APNA Card">

    <!-- SEO -->
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://apnacard.netlify.app/student/dashboard">
    <meta name="theme-color" content="#0e3e98">
    <meta property="og:title" content="Student Dashboard â€” APNA Card">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://yourdomain.com/student/dashboard">
    <meta name="twitter:card" content="summary">
    
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path
                            d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7.07,18.28C7.5,17.38 10.12,16.5 12,16.5C13.88,16.5 16.5,17.38 16.93,18.28C15.57,19.36 13.86,20 12,20C10.14,20 8.43,19.36 7.07,18.28M18.36,16.83C16.93,15.09 13.46,14.5 12,14.5C10.54,14.5 7.07,15.09 5.64,16.83C4.62,15.5 4,13.82 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,13.82 19.38,15.5 18.36,16.83M12,6C10.06,6 8.5,7.56 8.5,9.5C8.5,11.44 10.06,13 12,13C13.94,13 15.5,11.44 15.5,9.5C15.5,7.56 13.94,6 12,6M12,11A1.5,1.5 0 0,1 10.5,9.5A1.5,1.5 0 0,1 12,8A1.5,1.5 0 0,1 13.5,9.5A1.5,1.5 0 0,1 12,11Z" />
                    </svg>
                    <span class="brand-text">APNA Card</span>
                </div>
            </div>

            <ul class="sidebar-nav">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active" data-section="dashboard">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M13,3V9H21V3M13,21H21V11H13M3,21H11V15H3M3,13H11V3H3V13Z" />
                        </svg>
                        <span class="link-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#profile" class="nav-link" data-section="profile">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path
                                d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                        </svg>
                        <span class="link-text">Profile</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#id-card" class="nav-link" data-section="id-card">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path
                                d="M2,3H22C23.05,3 24,3.95 24,5V19C24,20.05 23.05,21 22,21H2C0.95,21 0,20.05 0,19V5C0,3.95 0.95,3 2,3M14,6V7H22V6H14M14,8V9H21.5L22,9V8H14M14,10V11H21V10H14M8,13.91C6,13.91 2,15 2,17V18H14V17C14,15 10,13.91 8,13.91M8,6A3,3 0 0,0 5,9A3,3 0 0,0 8,12A3,3 0 0,0 11,9A3,3 0 0,0 8,6Z" />
                        </svg>
                        <span class="link-text">ID Card</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <svg class="icon icon-outline" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                                d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
                        </svg>
                        <span class="link-text">Logout</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Bar -->
            <div class="topbar">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <svg class="icon icon-outline" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M3 6H21M3 12H21M3 18H21" />
                    </svg>
                </button>

                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        <!-- User initials will be inserted here -->
                    </div>
                    <div>
                        <div style="font-weight: 600;" id="userName"></div>
                        <div style="font-size: 0.875rem; color: #64748b;" id="userRole">Student</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <div id="alert-container"></div>

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Welcome back! Here's your student overview.</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                                </svg>
                            </div>
                            <div class="stat-info">
                                <h3 id="profileCompletion">0%</h3>
                                <p>Profile Completion</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,14H13V16H11V14M11,6H13V12H11V6Z" />
                                </svg>
                            </div>
                            <div class="stat-info">
                                <h3 id="approvalStatus">Pending</h3>
                                <p>Approval Status</p>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon success">
                                <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M2,3H22C23.05,3 24,3.95 24,5V19C24,20.05 23.05,21 22,21H2C0.95,21 0,20.05 0,19V5C0,3.95 0.95,3 2,3M14,6V7H22V6H14M14,8V9H21.5L22,9V8H14M14,10V11H21V10H14M8,13.91C6,13.91 2,15 2,17V18H14V17C14,15 10,13.91 8,13.91M8,6A3,3 0 0,0 5,9A3,3 0 0,0 8,12A3,3 0 0,0 11,9A3,3 0 0,0 8,6Z" />
                                </svg>
                            </div>
                            <div class="stat-info">
                                <h3 id="idCardStatus">Not Available</h3>
                                <p>ID Card Status</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile-section" class="content-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">Profile Management</h1>
                        <p class="page-subtitle">Complete your profile to generate your ID card</p>
                    </div>

                    <div class="profile-section">
                        <div class="profile-card">
                            <div class="profile-header">
                                <div class="profile-photo" id="profilePhotoDisplay">
                                    <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                                    </svg>
                                </div>
                                <h3 id="profileDisplayName">Update Your Profile</h3>
                                <p>Upload your photo and complete details</p>
                            </div>

                            <div class="profile-body">
                                <div class="form-group">
                                    <label class="form-label">Profile Photo</label>
                                    <div class="form-file">
                                        <input type="file" id="profilePhoto" accept="image/jpeg,image/jpg,image/png">
                                        <label for="profilePhoto" class="form-file-label">
                                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                                <path
                                                    d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                                            </svg>
                                            Choose Photo
                                        </label>
                                    </div>
                                    <small style="color: #64748b;">Max 5MB, JPG/PNG only</small>
                                </div>
                            </div>
                        </div>

                        <div class="profile-card">
                            <div class="card-header"
                                style="padding: var(--spacing-lg); border-bottom: 1px solid #e2e8f0;">
                                <h3 style="margin: 0;">Personal Information</h3>
                            </div>

                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="form-group">
                                        <label class="form-label" for="cnic">CNIC Number</label>
<input type="text" id="cnic" name="cnic" class="form-control"
                                            placeholder="12345-1234567-1" pattern="\d{5}-\d{7}-\d{1}" maxlength="15" inputmode="numeric">
                                        <small style="color: #64748b;">Format: 12345-1234567-1 (13 digits with dashes)</small>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="registrationNumber">Registration Number</label>
                                        <input type="text" id="registrationNumber" name="registrationNumber"
                                            class="form-control" placeholder="2024-CS-123"
                                            pattern="\d{4}-[A-Z]{2}-\d{2,4}">
                                        <small style="color: #64748b;">Format: 2024-CS-123</small>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="expiryDate">ID Card Expiry Date</label>
                                        <input type="date" id="expiryDate" name="expiryDate" class="form-control">
                                    </div>

                                    <div style="display: flex; gap: var(--spacing-md);">
                                        <button type="submit" class="btn btn-primary" id="updateProfileBtn">
                                            <span id="updateText">Update Profile</span>
                                            <div id="updateLoading" class="loading" style="display: none;"></div>
                                        </button>

                                        <button type="button" class="btn btn-success" id="submitApprovalBtn"
                                            style="display: none;">
                                            Submit for Approval
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ID Card Section -->
                <div id="id-card-section" class="content-section" style="display: none;">
                    <div class="page-header">
                        <h1 class="page-title">ID Card Generator</h1>
                        <p class="page-subtitle">Generate and download your official student ID card</p>
                    </div>

                    <div class="id-card-section">
                        <div id="cardStatusContainer">
                            <!-- Status will be inserted here -->
                        </div>

                        <div id="cardContainer" style="display: none;">
                            <!-- ID Card will be generated here -->
                        </div>

                        <div id="downloadButtons" style="display: none; margin-top: var(--spacing-xl);">
                            <button class="btn btn-primary" onclick="downloadCard('png')">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                                </svg>
                                Download PNG
                            </button>
                            <button class="btn btn-secondary" onclick="downloadCard('pdf')"
                                style="margin-left: var(--spacing-md);">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                                </svg>
                                Download PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <footer class="site-footer footer--compact" style="margin-top: var(--spacing-2xl);" role="contentinfo" aria-label="Site footer">
                <div class="container">
                    <div class="footer-compact">
                        <div class="footer-brand">
                            <svg class="icon-lg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>
                            <span class="brand-text">APNA Card</span>
                        </div>
                        <nav class="footer-links" aria-label="Footer">
                            <a href="/">Home</a>
                            <a href="/about">About</a>
                            <a href="/register">Register</a>
                        </nav>
                        <div class="footer-socials">
                            <a href="#" aria-label="Twitter"><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M22 5.8c-.8.3-1.6.6-2.4.7.9-.6 1.5-1.3 1.8-2.3-.9.5-1.8.9-2.8 1.1A4.1 4.1 0 0 0 12 8.9c0 .3 0 .6.1.9-3.4-.2-6.4-1.8-8.4-4.3-.4.7-.6 1.4-.6 2.2 0 1.4.7 2.7 1.8 3.5-.7 0-1.3-.2-1.9-.5 0 2 1.5 3.8 3.4 4.2-.4.1-.8.2-1.2.2-.3 0-.6 0-.9-.1.6 1.7 2.2 2.9 4.1 3a8.3 8.3 0 0 1-5.1 1.7H3a11.7 11.7 0 0 0 6.3 1.9c7.6 0 11.8-6.3 11.8-11.8v-.5c.8-.5 1.5-1.2 2-2z"/></svg></a>
                        </div>
                    </div>
                    <div class="footer-bottom">
                        <span>&copy; 2025 APNA Card â€” UET Lahore</span>
                        <span>Student panel â€¢ Premium, mobile-first</span>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <script src="/js/footer.js" defer></script>
    
    <!-- Include html2canvas and jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let currentSection = 'dashboard';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            checkAuth();
            initializeDashboard();
            setupEventListeners();
        });

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                window.location.href = '/login';
                return;
            }

            currentUser = JSON.parse(user);

            // Check if user is student
            if (currentUser.role !== 'student') {
                window.location.href = '/login';
                return;
            }

            // Update UI with user info
            updateUserInfo();
        }

        // Update user info in UI
        function updateUserInfo() {
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            const profileDisplayName = document.getElementById('profileDisplayName');

            userName.textContent = currentUser.fullName;
            userAvatar.textContent = currentUser.fullName.charAt(0).toUpperCase();
            profileDisplayName.textContent = currentUser.fullName;
        }

        // Initialize dashboard
        async function initializeDashboard() {
            await loadStudentProfile();
            updateDashboardStats();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    if (this.getAttribute('data-section')) {
                        e.preventDefault();
                        navigateToSection(this.getAttribute('data-section'));
                    }
                });
            });

            // Profile form
            document.getElementById('profileForm').addEventListener('submit', updateProfile);

            // Profile photo upload
            document.getElementById('profilePhoto').addEventListener('change', handlePhotoUpload);

            // Submit for approval
            document.getElementById('submitApprovalBtn').addEventListener('click', submitForApproval);
            
            // CNIC auto-formatting
            const cnicInput = document.getElementById('cnic');
            if (cnicInput) {
                cnicInput.addEventListener('input', formatCNIC);
                cnicInput.addEventListener('keydown', handleCNICKeydown);
            }
            
            // Student ID auto-formatting
            const regNumberInput = document.getElementById('registrationNumber');
            if (regNumberInput) {
                regNumberInput.addEventListener('input', function() {
                    formatAndValidateStudentId(this);
                });
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.querySelector('.sidebar-overlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            if (window.innerWidth > 1024) {
                mainContent.classList.toggle('sidebar-open');
            }
        }

        // Navigate to section
        function navigateToSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });

            // Show selected section
            document.getElementById(section + '-section').style.display = 'block';

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            currentSection = section;

            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.sidebar-overlay').classList.remove('active');
            }

            // Load section-specific data
            if (section === 'id-card') {
                loadIdCardSection();
            }
        }

        // Load student profile
        async function loadStudentProfile() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const profile = result.data;

                    // Update form fields
if (profile.cnic) {
                        const cnicDigits = String(profile.cnic).replace(/\D/g, '');
                        let formatted = '';
                        if (cnicDigits.length >= 5) {
                            formatted = cnicDigits.substring(0, 5);
                            if (cnicDigits.length >= 12) {
                                formatted += '-' + cnicDigits.substring(5, 12);
                                if (cnicDigits.length >= 13) {
                                    formatted += '-' + cnicDigits.substring(12, 13);
                                }
                            } else if (cnicDigits.length > 5) {
                                formatted += '-' + cnicDigits.substring(5);
                            }
                        } else {
                            formatted = cnicDigits;
                        }
                        document.getElementById('cnic').value = formatted;
                    }
                    if (profile.registrationNumber) document.getElementById('registrationNumber').value = profile.registrationNumber;
                    if (profile.expiryDate) {
                        document.getElementById('expiryDate').value = new Date(profile.expiryDate).toISOString().split('T');
                    }

                    // Update profile photo
                    if (profile.profilePhoto && profile.profilePhoto.filename) {
                        const photoDisplay = document.getElementById('profilePhotoDisplay');
                        photoDisplay.innerHTML = `<img src="/api/uploads/${profile.profilePhoto.filename}" alt="Profile Photo">`;
                    }

                    // Show submit button if profile is complete but not submitted
                    if (isProfileComplete(profile) && !profile.profileSubmitted) {
                        document.getElementById('submitApprovalBtn').style.display = 'inline-block';
                    }

                    // Store current profile
                    currentUser.profile = profile;
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('Load profile error:', error);
                showAlert('Failed to load profile', 'danger');
            }
        }

        // Check if profile is complete
        function isProfileComplete(profile) {
            return profile.profilePhoto && profile.cnic && profile.registrationNumber && profile.expiryDate;
        }

        // Update dashboard stats
        function updateDashboardStats() {
            const profile = currentUser.profile || {};

            // Profile completion
            let completionCount = 0;
            if (profile.profilePhoto) completionCount++;
            if (profile.cnic) completionCount++;
            if (profile.registrationNumber) completionCount++;
            if (profile.expiryDate) completionCount++;

            const completionPercent = Math.round((completionCount / 4) * 100);
            document.getElementById('profileCompletion').textContent = completionPercent + '%';

            // Approval status
            const approvalStatus = profile.approvalStatus || 'pending';
            document.getElementById('approvalStatus').textContent = approvalStatus.charAt(0).toUpperCase() + approvalStatus.slice(1);

            // ID Card status
            const idCardStatus = approvalStatus === 'approved' ? 'Available' : 'Not Available';
            document.getElementById('idCardStatus').textContent = idCardStatus;
        }
        // Handle photo upload
        async function handlePhotoUpload(event) {
            const fileList = event.target.files;
            if (!fileList || fileList.length === 0) return;
            
            const file = fileList[0]; // Get the first file from FileList

            // Validate file
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!allowedTypes.includes(file.type)) {
                showAlert('Please select a JPG or PNG image', 'danger');
                return;
            }

            if (file.size > maxSize) {
                showAlert('File size must be less than 5MB', 'danger');
                return;
            }

            // Preview image immediately
            const reader = new FileReader();
            reader.onload = function (e) {
                const photoDisplay = document.getElementById('profilePhotoDisplay');
                photoDisplay.innerHTML = `<img src="${e.target.result}" alt="Profile Photo">`;
                
                // Show immediate feedback with SVG icon (no emojis per design rule)
                showAlert('<svg class="icon" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px;"><path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12C20,16.41 16.41,20 12,20M11,17H13V11H11V17Z"/></svg>Image preview updated. Uploading...', 'info');
            };
            reader.readAsDataURL(file);

            // Upload image
            const formData = new FormData();
            formData.append('profilePhoto', file);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Clear any previous messages and show success (SVG icon, no emojis)
                    clearAlerts();
                    showAlert('<svg class="icon" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px;"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>Image uploaded successfully. Your profile photo has been updated.', 'success');
                    currentUser.profile = result.data;
                    updateDashboardStats();

                    // Show submit button if profile is complete
                    if (isProfileComplete(result.data) && !result.data.profileSubmitted) {
                        document.getElementById('submitApprovalBtn').style.display = 'inline-block';
                    }
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('Photo upload error:', error);
                showAlert('Failed to upload photo', 'danger');
            }
        }

        // Update profile
        async function updateProfile(e) {
            e.preventDefault();

            const updateBtn = document.getElementById('updateProfileBtn');
            const updateText = document.getElementById('updateText');
            const updateLoading = document.getElementById('updateLoading');

            // Show loading state
            updateBtn.disabled = true;
            updateText.style.display = 'none';
            updateLoading.style.display = 'inline-block';

            const formData = new FormData(e.target);
            const profileData = {
cnic: (formData.get('cnic') || '').replace(/\D/g, ''),
                registrationNumber: formData.get('registrationNumber'),
                expiryDate: formData.get('expiryDate')
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/student/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Profile updated successfully', 'success');
                    currentUser.profile = result.data;
                    updateDashboardStats();

                    // Show submit button if profile is complete
                    if (isProfileComplete(result.data) && !result.data.profileSubmitted) {
                        document.getElementById('submitApprovalBtn').style.display = 'inline-block';
                    }
                } else {
                    showAlert(result.message, 'danger');
                }
            } catch (error) {
                console.error('Update profile error:', error);
                showAlert('Failed to update profile', 'danger');
            } finally {
                // Reset button state
                updateBtn.disabled = false;
                updateText.style.display = 'inline';
                updateLoading.style.display = 'none';
            }
        }

        // Submit for approval
        async function submitForApproval() {
            const profile = currentUser.profile || {};

            if (!isProfileComplete(profile)) {
                showAlert('Please complete all profile fields before submitting', 'warning');
                return;
            }

            if (confirm('Are you sure you want to submit your profile for approval? You won\'t be able to edit it after submission.')) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/student/submit-approval', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('Profile submitted for approval successfully', 'success');
                        document.getElementById('submitApprovalBtn').style.display = 'none';

                        // Update user profile
                        currentUser.profile.profileSubmitted = true;
                        currentUser.profile.approvalStatus = 'pending';
                        updateDashboardStats();
                    } else {
                        showAlert(result.message, 'danger');
                    }
                } catch (error) {
                    console.error('Submit approval error:', error);
                    showAlert('Failed to submit for approval', 'danger');
                }
            }
        }

        // Load ID card section
        async function loadIdCardSection() {
            const cardStatusContainer = document.getElementById('cardStatusContainer');
            const cardContainer = document.getElementById('cardContainer');
            const downloadButtons = document.getElementById('downloadButtons');

            const profile = currentUser.profile || {};
            const approvalStatus = profile.approvalStatus || 'pending';

            if (approvalStatus === 'approved') {
                // Load approved card
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/student/id-card', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        generateIdCard(result.data);
                        cardStatusContainer.innerHTML = `
                            <div class="status-badge status-approved">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
                                </svg>
                                Your ID card is ready for download
                            </div>
                        `;
                        cardContainer.style.display = 'block';
                        downloadButtons.style.display = 'block';
                    } else {
                        showAlert(result.message, 'danger');
                    }
                } catch (error) {
                    console.error('Load ID card error:', error);
                    showAlert('Failed to load ID card', 'danger');
                }
            } else if (approvalStatus === 'pending') {
                cardStatusContainer.innerHTML = `
                    <div class="status-badge status-pending">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,14H13V16H11V14M11,6H13V12H11V6Z"/>
                        </svg>
                        Your ID card request is pending admin approval
                    </div>
                    <p style="color: #64748b; margin-top: var(--spacing-lg);">
                        Please wait while our admin team reviews your profile. You'll be able to download your ID card once it's approved.
                    </p>
                `;
                cardContainer.style.display = 'none';
                downloadButtons.style.display = 'none';
            } else if (approvalStatus === 'rejected') {
                cardStatusContainer.innerHTML = `
                    <div class="status-badge status-rejected">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                        </svg>
                        Your ID card request was rejected
                    </div>
                    <p style="color: #64748b; margin-top: var(--spacing-lg);">
                        Please update your profile information and resubmit for approval.
                    </p>
                `;
                cardContainer.style.display = 'none';
                downloadButtons.style.display = 'none';
            } else {
                cardStatusContainer.innerHTML = `
                    <div class="status-badge status-pending">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,14H13V16H11V14M11,6H13V12H11V6Z"/>
                        </svg>
                        Complete your profile to request ID card
                    </div>
                    <p style="color: #64748b; margin-top: var(--spacing-lg);">
                        Please complete your profile information and submit for approval to generate your ID card.
                    </p>
                `;
                cardContainer.style.display = 'none';
                downloadButtons.style.display = 'none';
            }
        }

        // Format CNIC for display in ID card
        function formatCNICForDisplay(cnic) {
            if (!cnic) return '';
            const digits = String(cnic).replace(/\D/g, '');
            if (digits.length === 13) {
                return `${digits.substring(0, 5)}-${digits.substring(5, 12)}-${digits.substring(12, 13)}`;
            }
            return digits;
        }

        // Generate ID card using the exact template provided
        function generateIdCard(cardData) {
            const cardContainer = document.getElementById('cardContainer');

            // Format expiry date
            const expiryDate = new Date(cardData.expiryDate);
            const formattedExpiry = (expiryDate.getMonth() + 1) + '/' + expiryDate.getDate() + '/' + expiryDate.getFullYear();

            // Generate ID card HTML using the exact template
            cardContainer.innerHTML = `
                <div class="uet-card" id="uetCard">
                    <!-- HEADER -->
                    <div class="uet-header">
                        <div class="uet-header-bg">
                            <img src="/images/vg.png" alt="UET Building Background">
                        </div>
                        <div class="uet-logo">
                            <img src="/images/6.png" alt="UET Logo">
                        </div>
                        <div class="uet-title">
                            UNIVERSITY OF ENGINEERING &<br>
                            <span class="centered-text">TECHNOLOGY LAHORE</span>
                        </div>
                    </div>
                    <div class="uet-divider"></div>
                    <!-- BODY -->
                    <div class="uet-body">
                        <div class="uet-watermark">
                            <img src="/images/6.png" alt="UET Watermark">
                        </div>
                        <div class="uet-info">
                            <div class="uet-student-name">${cardData.fullName.toUpperCase()}</div>
                            <div class="uet-details">
                                <div><label>Reg No:</label>${cardData.registrationNumber}</div>
                                <div><label>CNIC #:</label>${formatCNICForDisplay(cardData.cnic)}</div>
                                <div><label>Expiry Date:</label>${formattedExpiry}</div>
                            </div>
                        </div>
                        <div class="uet-photo-wrap">
                            <img src="/api/uploads/${cardData.profilePhoto.filename}" alt="Student Photo">
                        </div>
                    </div>
                </div>
            `;

            // Add the exact CSS from the template
            addIdCardStyles();
        }

        // Add ID card styles (from the provided template)
        function addIdCardStyles() {
            if (document.getElementById('idCardStyles')) return;

            const style = document.createElement('style');
            style.id = 'idCardStyles';
            style.textContent = `
    .uet-card {
      width: 410px;
      height: 225px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 7px 20px #0002;
      overflow: hidden;
      margin: 55px auto 0 auto;
      border: 1.4px solid #e6e6e7;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    /* HEADER SECTION */
    .uet-header {
      width: 100%;
      height: 60px;
      position: relative;
      background: #fff;
      display: flex;
      align-items: flex-end;
      z-index: 2;
      box-sizing: border-box;
      padding-left: 12px;
      padding-top: 7px;
      padding-bottom: 0;
      overflow: visible;
    }
    .uet-header-bg {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
    }
    .uet-header-bg img {
      width: 100%;
      height: 100%;
      align-items: center;
      justify-content: center;
      object-fit: cover;
      opacity: 0.23; /* Lowered for less visibility, matches card */
    }
    .uet-logo {
      z-index: 2;
      flex-shrink: 0;
      width: 39px;
      height: 39px;
      margin-right: 11px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .uet-logo img {
      width: 110%;
      height: 110%;
      object-fit: contain;
    }
    .uet-title {
      font-size: 18px;
      line-height: 1;
      letter-spacing: 0.19px;
      text-transform: uppercase;
      font-weight: 550;
      color: #0e3e98;
      z-index: 2;
      text-shadow:
        2px 1.5px 0px #ffe600,
        2px 3.5px 7px #ffe600cc,
        0 0px 1.5px #fff;
      font-family: 'Lato', sans-serif; 
      margin-bottom: 7px;
    }
    .centered-text {
  display: block;
  text-align: center;
}

    /* YELLOW DIVIDER */
    .uet-divider {
      width: 100%;
      height: 8.5px;
      background: #ffe600;
      border: none;
      margin: 0;
      box-shadow:
        0 1px 5px #fde03190,
        0 1.7px 1.5px #fff8;
      z-index: 3;
    }
    /* BOTTOM (BODY) SECTION */
    .uet-body {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      padding: 18px 15px 0 20px;
      background: #fff;
      z-index: 1;
      box-sizing: border-box;
    }
    /* WATERMARK LOGO CENTERED */
    .uet-watermark {
      position: absolute;
      left: 50%;
      top: 56%;
      transform: translate(-50%, -54%);
      opacity: 0.13;
      z-index: 0;
      filter:
        drop-shadow(0 3.5px 15px #ffe60099)
        drop-shadow(0 1.5px 5px #646c6190);
      pointer-events: none;
    }
    .uet-watermark img {
      width: 112px;
      height: 112px;
      object-fit: contain;
      display: block;
    }
    /* TEXT INFO */
    .uet-info {
      flex: 1.5;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start; /* ensure left alignment on cross-axis */
      text-align: left; /* force left text alignment */
      min-width: 0;
    }
    .uet-student-name {
      font-size: 1.35rem;
      font-weight: 900;
      font-family: 'Arial Black', Arial, sans-serif;
      margin-bottom: 14px;
      margin-top: 2px;
      color: #2c2c2c;
      letter-spacing: 0.5px;
      line-height: 1.1;
      text-align: left;
      text-transform: uppercase;
    }
    .uet-details {
      font-size: 0.95rem;
      margin-bottom: 12px;
      color: #3a3a3a;
      line-height: 1.75;
      letter-spacing: 0.1px;
      text-align: left;
      font-family: Arial, sans-serif;
      font-weight: 500;
    }
    .uet-details div {
      font-size: 0.95rem !important;
      font-family: Arial, sans-serif;
      font-weight: 500;
      color: #3a3a3a;
    }
    .uet-details label {
      font-size: 0.95rem !important;
      font-weight: 600;
      margin-right: 6px;
      font-family: Arial, sans-serif;
      color: #2a2a2a;
    }
    /* PHOTO */
    .uet-photo-wrap {
      z-index: 2;
      width: 110px;
      height: 115px;
      border: 2.5px solid #171717;
      margin-left: 25px;
      margin-top: 3px;
      background: #fff;
      box-shadow: 0 1.8px 7px #ffe60068;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .uet-photo-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #fff;
      display: block;
    }
    @media (max-width: 440px) {
      .uet-card { width: 98vw; height: auto; }
      .uet-header, .uet-body { padding-left: 2.5vw; padding-right: 2.5vw; }
      .uet-photo-wrap { width: 60px; height: 60px; }
      .uet-watermark img { width: 80px; height: 80px; }
    }
            `;
            document.head.appendChild(style);
        }

        // Download card function
        async function downloadCard(format) {
            const card = document.getElementById('uetCard');

            if (format === 'png') {
                try {
                    const canvas = await html2canvas(card, {
                        backgroundColor: null,
                        scale: 2, // High quality
                        width: 410,
                        height: 225
                    });

                    // Convert to blob and download
                    canvas.toBlob(function (blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${currentUser.fullName.replace(/\s+/g, '_')}_ID_Card.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });

                } catch (error) {
                    console.error('PNG download error:', error);
                    showAlert('Failed to download PNG', 'danger');
                }
            } else if (format === 'pdf') {
                try {
                    const canvas = await html2canvas(card, {
                        backgroundColor: null,
                        scale: 2,
                        width: 410,
                        height: 225
                    });

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'px',
                        format: [410, 225]
                    });

                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 0, 0, 410, 225);
                    pdf.save(`${currentUser.fullName.replace(/\s+/g, '_')}_ID_Card.pdf`);

                } catch (error) {
                    console.error('PDF download error:', error);
                    showAlert('Failed to download PDF', 'danger');
                }
            }
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const token = localStorage.getItem('token');
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }

                // Clear local storage and redirect
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
        }

        // Clear all alerts
        function clearAlerts() {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = '';
        }

        // Show alert function
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message; // Use innerHTML to support emojis
            
            // Add styles for different alert types
            alert.style.cssText = `
                padding: 12px 16px;
                margin-bottom: 16px;
                border-radius: 8px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                animation: slideIn 0.3s ease-out;
            `;
            
            // Set colors based on type
            switch(type) {
                case 'success':
                    alert.style.backgroundColor = '#dcfce7';
                    alert.style.color = '#166534';
                    alert.style.border = '1px solid #bbf7d0';
                    break;
                case 'danger':
                    alert.style.backgroundColor = '#fee2e2';
                    alert.style.color = '#dc2626';
                    alert.style.border = '1px solid #fecaca';
                    break;
                case 'warning':
                    alert.style.backgroundColor = '#fef3c7';
                    alert.style.color = '#d97706';
                    alert.style.border = '1px solid #fed7aa';
                    break;
                case 'info':
                    alert.style.backgroundColor = '#dbeafe';
                    alert.style.color = '#1d4ed8';
                    alert.style.border = '1px solid #bfdbfe';
                    break;
            }
            
            alertContainer.appendChild(alert);

            // Auto remove after 5 seconds (except for success messages which stay longer)
            const duration = type === 'success' ? 7000 : 5000;
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => alert.remove(), 300);
                }
            }, duration);
        }

        // CNIC formatting functions
        function formatCNIC(event) {
            const input = event.target;
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            
            // Limit to 13 digits
            value = value.substring(0, 13);
            
            // Apply formatting: XXXXX-XXXXXXX-X
            let formatted = '';
            if (value.length > 0) {
                formatted = value.substring(0, 5);
                if (value.length > 5) {
                    formatted += '-' + value.substring(5, 12);
                    if (value.length > 12) {
                        formatted += '-' + value.substring(12, 13);
                    }
                }
            }
            
            input.value = formatted;
        }
        
        function handleCNICKeydown(event) {
            const input = event.target;
            const key = event.key;
            
            // Allow: backspace, delete, tab, escape, enter
            if (['Backspace', 'Delete', 'Tab', 'Escape', 'Enter'].includes(key)) {
                return;
            }
            
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            if (event.ctrlKey && ['a', 'c', 'v', 'x'].includes(key.toLowerCase())) {
                return;
            }
            
            // Allow: home, end, left, right
            if (['Home', 'End', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                return;
            }
            
            // Allow only digits
            if (!/^[0-9]$/.test(key)) {
                event.preventDefault();
            }
        }
        
        // Student ID formatting and validation
        function formatAndValidateStudentId(input) {
            let value = input.value.trim();
            
            // Convert to uppercase for consistency
            const parts = value.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const dept = parts[1].toUpperCase(); // Convert department to uppercase
                const number = parts[2];
                value = `${year}-${dept}-${number}`;
                input.value = value;
            }
            
            return value;
        }

        // Responsive sidebar handling
        window.addEventListener('resize', function () {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.querySelector('.sidebar-overlay');

            if (window.innerWidth > 1024) {
                if (sidebar.classList.contains('active')) {
                    mainContent.classList.add('sidebar-open');
                }
                overlay.classList.remove('active');
            } else {
                mainContent.classList.remove('sidebar-open');
            }
        });
    </script>
</body>

</html>